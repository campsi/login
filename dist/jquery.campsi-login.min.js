!function(n){function e(n){var e=n.translations;return{login:"#"+e.idPrefix,signin:"#"+e.idPrefix+"-"+e.signinId,signup:"#"+e.idPrefix+"-"+e.signupId,resetPassword:"#"+e.idPrefix+"-"+e.resetPasswordId}}function i(i,t){function a(e,a){return n("<form>").attr({id:e.substr(1),class:"local "+a,action:i.baseUrl+"/"+t.name+"/"+a,method:"POST"})}function s(e){return n('<div class="links">').append(e.map(function(e){return n("<a>").attr("href",e.href).text(e.text)}))}function o(){return a(p.signin,"signin").append([n("<h2>").text(d.signinTitle),n("<input>").attr({type:"text",name:"username",placeholder:d.usernamePH}),n("<input>").attr({type:"password",name:"password",placeholder:d.passwordPH}),n("<input>").attr({type:"hidden",name:"action",value:"signin"}),n("<input>").attr({type:"hidden",name:"invitation",value:i.invitation}),n('<div class="submit">').append(n("<button>").text(d.signinSubmitText)),s([{href:p.resetPassword,text:d.resetPasswordLink},{href:p.signup,text:d.signupLink}])])}function r(){return a(p.signup,"signup").append([n("<h2>").text(d.signupTitle),n("<input>").attr({type:"text",name:"displayName",placeholder:d.displayNamePH}),n("<input>").attr({type:"email",name:"email",placeholder:d.emailPH}),n("<input>").attr({type:"text",name:"username",placeholder:d.usernamePH}),n("<input>").attr({type:"password",name:"password",placeholder:d.passwordPH}),n("<input>").attr({type:"password",name:"password_verify",placeholder:d.passwordVerifyPH}),n("<input>").attr({type:"hidden",name:"action",value:"signup"}),n("<input>").attr({type:"hidden",name:"invitation",value:i.invitation}),n('<div class="submit">').append(n("<button>").text(d.signupSubmitText)),s([{href:p.signin,text:d.signinLink}])])}function l(){return a(p.resetPassword,"signup").append([n("<h2>").text(d.resetPasswordTitle),n("<input>").attr({type:"email",name:"email",placeholder:d.emailPH}),n("<input>").attr({type:"hidden",name:"action",value:"reset-password"}),n('<div class="submit">').append(n("<button>").text(d.resetPasswordSubmitText)),s([{href:p.signin,text:d.signinLink}])])}var d=i.translations,p=e(i);return n('<div class="forms">').append([o(),l(),r()])}function t(e,i){var t=n('<a class="auth"></a>'),a="http://localhost:3000/auth/"+i.name;return e.invitation&&(a+="?invitation="+encodeURIComponent(e.invitation)),t.addClass(i.name),t.attr({href:a}),t.text(i.name),t}function a(e){var a=n("<div />").addClass("campsi-login").hide().append('<div class="fx">').append(n('<a class="close"></a>')).append('<div class="logo">').append(n("<h1>").html(e.translations.title)).append('<div class="user"></div>').append(n('<div class="buttons">'));return e.logo&&a.find(".logo").append(n("<img>").attr("src",e.logo)).css(e.logoStyle),n(e.providers).each(function(){"local"===this.name?a.append(i(e,this)):a.find(".buttons").append(t(e,this))}),a}function s(e,i,t){t=t||function(n){var e=new Error("campsi/login could not retreive auth providers");throw e.response=n,e},n.ajax({url:e.baseUrl+"/providers",dataType:"json",error:t}).done(i)}function o(n){return function(e){n.token&&e.setRequestHeader("Authorization","Bearer "+n.token.value)}}function r(e,i,t){n.ajax({url:e.baseUrl+"/me",beforeSend:o(e),success:i,error:t,dataType:"json"})}function l(n){var e=window.location.search,i=e.indexOf(n+"="),t=e.indexOf("&",i);if(i>-1)return i+=n.length+1,decodeURIComponent(e.substring(i,t===-1?e.length:t))}function d(n){var e,i,t=n.token||l("token"),a=typeof t;if("object"===a)return n.token;if(t&&"string"===a){try{e=JSON.parse(atob(t))}catch(n){console.dir(t),console.warn("invalid token"),console.warn(n)}return e}i=window.localStorage.getItem(n.localStorageKey);try{e=JSON.parse(i)}catch(n){console.warn("campsi/login could not parse stored token"),console.warn(n)}return e}function p(n,e){var i=n.data("campsi-login-settings");if(!i)return void console.error("campsi/login has not been instanciated. Please call $el.CampsiLogin({options}) first.");switch(e){case"show":g(n,i);break;case"hide":c(n);break;case"logout":u(n,i),g(n,i);break;case"displayUser":f(n,i);break;default:console.warn("campsi/login unknown command",e)}return n}function u(e,i){n.ajax({url:i.baseUrl+"/logout",dataType:"json",beforeSend:o(i)}).done(function(){window.localStorage.removeItem(i.localStorageKey),e.find(".user").empty(),e.removeClass("userLoggedIn"),e.find(".forms").show(),w(e,i)})}function c(n){n.removeClass("visible").addClass("closed")}function g(n){n.addClass("visible").removeClass("closed")}function m(e){var i;if("object"==typeof e){if(e.translations&&(e.translations=n.extend({},n.fn.CampsiLogin.defaults.translations,e.translations)),i=n.extend({},n.fn.CampsiLogin.defaults,e),i.token=d(i),i.invitation=i.invitation||l("invitation"),!i.baseUrl)throw new Error("campsi/login missing baseUrl option");return i}}function f(e,i){var t=e.data("campsi-login-user"),a=i.translations;if(!t)return void console.error("campsi/login displayUser was called, but no user found");var s=n('<a href="#campsi-logout">').text(a.logoutText).on("click",function(){e.CampsiLogin("logout")});e.find(".user").empty().append(n('<div class="displayName">').text(t.displayName)).append(n('<div class="pictureWrapper">').append(n("<img>").attr("src",t.pictureUrl))).append(s)}function h(e,i){e.on("click",".close",function(){e.CampsiLogin("hide")}),n(window).on("hashchange",function(){w(e,i)})}function w(n,i){var t=e(i),a=0===location.hash.indexOf("#"+i.translations.idPrefix)?location.hash:null,s=a||t[i.state]||t.signin;n.find("form").hide(),n.find(s).show()}n.fn.CampsiLogin=function(e){function i(){t.find(".campsi-login").show(),n(window).trigger("hashchange")}var t=this,o=m(e);return"string"==typeof e?p(t,e):t.hasClass("campsi-login-wrapper")?void console.info("campsi/login has already been inited"):(s(o,function(n){o.providers=n,t.append(a(o)).addClass("campsi-login-wrapper").data("campsi-login-settings",o),h(t,o),o.token?r(o,function(n){window.localStorage.setItem(o.localStorageKey,JSON.stringify(n.token)),t.data("campsi-login-user",n).CampsiLogin("displayUser").addClass("userLoggedIn").trigger("login",n).find(".forms").hide(),i()},function(){t.trigger("loginError"),i()}):i()}),t)},n.fn.CampsiLogin.defaults={autoShow:!0,localStorageKey:"campsi-login-token",logoStyle:{},translations:{title:"Login",idPrefix:"campsi-login",signinId:"signin",signinSubmitText:"Sign in",signinLink:"I remember!",signinTitle:"Sign in",signupId:"signup",signupSubmitText:"Sign up",signupLink:"Sign up",signupTitle:"Sign up",resetPasswordId:"reset-password",resetPasswordSubmitText:"Send me the link",resetPasswordLink:"Forgot your password?",resetPasswordTitle:"Reset password",displayNamePH:"Display name",emailPH:"Email address",usernamePH:"Username",passwordPH:"Password",passwordVerifyPH:"Verify your password",logoutText:"Log out"}}}(window.jQuery);