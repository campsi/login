!function(n){function e(n){var e=n.translations;return{login:"#"+e.idPrefix,signin:"#"+e.idPrefix+"-"+e.signinId,signup:"#"+e.idPrefix+"-"+e.signupId,resetPassword:"#"+e.idPrefix+"-"+e.resetPasswordId}}function i(i,t){function a(e){return n("<form>").attr({id:e,class:"local",action:i.baseUrl+"/"+t.name,method:"POST"})}function s(e){return n('<div class="links">').append(e.map(function(e){return n("<a>").attr("href",e.href).text(e.text)}))}function o(){return a("campsi-login-signin").append([n("<h2>").text(d.signinTitle),n("<input>").attr({type:"text",name:"username",placeholder:d.usernamePH}),n("<input>").attr({type:"password",name:"password",placeholder:d.passwordPH}),n("<input>").attr({type:"hidden",name:"action",value:"signin"}),n('<div class="submit">').append(n("<button>").text(d.signinSubmitText)),s([{href:p.resetPassword,text:d.resetPasswordLink},{href:p.signup,text:d.signupLink}])])}function r(){return a("campsi-login-signup").append([n("<h2>").text(d.signupTitle),n("<input>").attr({type:"text",name:"displayName",placeholder:d.displayNamePH}),n("<input>").attr({type:"email",name:"email",placeholder:d.emailPH}),n("<input>").attr({type:"text",name:"username",placeholder:d.usernamePH}),n("<input>").attr({type:"password",name:"password",placeholder:d.passwordPH}),n("<input>").attr({type:"password",name:"password_verify",placeholder:d.passwordVerifyPH}),n("<input>").attr({type:"hidden",name:"action",value:"signup"}),n('<div class="submit">').append(n("<button>").text(d.signupSubmitText)),s([{href:p.signin,text:d.signinLink}])])}function l(){return a("campsi-login-reset-password").append([n("<h2>").text(d.resetPasswordTitle),n("<input>").attr({type:"email",name:"email",placeholder:d.emailPH}),n("<input>").attr({type:"hidden",name:"action",value:"reset-password"}),n('<div class="submit">').append(n("<button>").text(d.resetPasswordSubmitText)),s([{href:p.signin,text:d.signinLink}])])}var d=i.translations,p=e(i);return[o(),l(),r()]}function t(e,i){var t=n('<a class="auth"></a>'),a="http://localhost:3000/auth/"+i.name;return e.invitation&&(a+="?invitation="+invitation),t.addClass(i.name),t.attr({href:a}),t.text(i.name),t}function a(e){var a=n("<div />").addClass("campsi-login").append('<div class="fx">').append(n('<a class="close"></a>')).append('<div class="logo">').append(n("<h1>").html(e.translations.title)).append('<div class="user"></div>').append(n('<div class="buttons">'));return e.logo&&a.find(".logo").append(n("<img>").attr("src",e.logo)).css(e.logoStyle),n(e.providers).each(function(){"local"===this.name?a.append(i(e,this)):a.find(".buttons").append(t(e,this))}),a}function s(e,i,t){t=t||function(n){var e=new Error("campsi/login could not retreive auth providers");throw e.response=n,e},n.ajax({url:e.baseUrl+"/providers",dataType:"json",error:t}).done(i)}function o(n){return function(e){n.token&&e.setRequestHeader("Authorization","Bearer "+n.token.value)}}function r(e,i,t){n.ajax({url:e.baseUrl+"/me",beforeSend:o(e),success:i,onError:t,dataType:"json"})}function l(n){var e,i,t=n.token,a=typeof t;if("object"===a)return n.token;if("string"===a){try{e=JSON.parse(atob(t))}catch(n){console.dir(t),console.warn("invalid token"),console.warn(n)}return e}i=window.localStorage.getItem(n.localStorageKey);try{e=JSON.parse(i)}catch(n){console.warn("campsi/login could not parse stored token"),console.warn(n)}return e}function d(n,e){var i=n.data("campsi-login-settings");if(!i)return void console.error("campsi/login has not been instanciated. Please call $el.CampsiLogin({options}) first.");switch(e){case"show":c(n,i);break;case"hide":u(n);break;case"logout":p(n,i),c(n,i);break;case"displayUser":f(n,i);break;default:console.warn("campsi/login unknown command",e)}}function p(e,i){n.ajax({url:i.baseUrl+"/logout",dataType:"json",beforeSend:o(i)}).done(function(){window.localStorage.removeItem(i.localStorageKey),e.find(".user").empty(),e.removeClass("userLoggedIn")})}function u(n){n.removeClass("visible").addClass("closed")}function c(n,e,i){return i=i||0,i>2?(console.error("campsi/login could not find .campsi-login"),!1):void(n.find(".campsi-login").length<1?g(n,e,function(){c(n,e,i+1)}):n.addClass("visible").removeClass("closed"))}function g(e,i,t){e.empty().addClass("campsi-login-wrapper").append(a(i)),e.trigger("ready"),n(window).trigger("hashchange"),t()}function m(e){e.translations&&(e.translations=n.extend({},n.fn.CampsiLogin.defaults.translations,e.translations));var i=n.extend({},n.fn.CampsiLogin.defaults,e);if(!i.baseUrl)throw new Error("campsi/login missing baseUrl option");return i}function f(e,i){var t=e.data("campsi-login-user"),a=i.translations;if(!t)return void console.error("campsi/login displayUser was called, but no user found");var s=n('<a href="#campsi-logout">').text(a.logoutText).on("click",function(){e.CampsiLogin("logout")});e.find(".user").empty().append(n('<div class="displayName">').text(t.displayName)).append(n('<div class="pictureWrapper">').append(n("<img>").attr("src",t.pictureUrl))).append(s)}n.fn.CampsiLogin=function(i){var t,a,o=this;return"string"==typeof i?d(o,i):(t=m(i),a=t.translations,n(window).on("hashchange",function(){if(!o.hasClass("userLoggedIn")){var n=0===location.hash.indexOf("#"+a.idPrefix)?location.hash:e(t).signin;o.find("form").hide(),o.find(n).show()}}),t.token=l(t),o.data("campsi-login-settings",t),s(t,function(n){t.providers=n,t.token&&r(t,function(n){window.localStorage.setItem(t.localStorageKey,JSON.stringify(n.token)),o.data("campsi-login-user",n),o.addClass("userLoggedIn"),o.trigger("login",n),o.CampsiLogin("displayUser")},function(){o.trigger("loginError"),o.CampsiLogin("show")}),t.autoShow&&o.CampsiLogin("show")}),o.on("click",".close",function(){o.CampsiLogin("hide")}),o)},n.fn.CampsiLogin.defaults={autoShow:!0,localStorageKey:"campsi-login-token",logoStyle:{},translations:{title:"Login",idPrefix:"campsi-login",signinId:"signin",signinSubmitText:"Sign in",signinLink:"I remember!",signinTitle:"Sign in",signupId:"signup",signupSubmitText:"Sign up",signupLink:"Sign up",signupTitle:"Sign up",resetPasswordId:"reset-password",resetPasswordSubmitText:"Send me the link",resetPasswordLink:"Forgot your password?",resetPasswordTitle:"Reset password",displayNamePH:"Display name",emailPH:"Email address",usernamePH:"Username",passwordPH:"Password",passwordVerifyPH:"Verify your password",logoutText:"Log out"}}}(window.jQuery);