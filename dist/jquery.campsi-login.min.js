!function(n){function e(n){var e=n.translations;return{login:"#"+e.idPrefix,signin:"#"+e.idPrefix+"-"+e.signinId,signup:"#"+e.idPrefix+"-"+e.signupId,resetPassword:"#"+e.idPrefix+"-"+e.resetPasswordId}}function t(t,i){function a(e,a){return n("<form>").attr({id:e.substr(1),class:"local "+a,action:t.baseUrl+"/"+i.name+"/"+a,method:"POST"})}function s(e){return n('<div class="links">').append(e.map(function(e){return n("<a>").attr("href",e.href).text(e.text)}))}function o(){return a(p.signin,"signin").append([n("<h2>").text(l.signinTitle),n("<input>").attr({type:"text",name:"username",placeholder:l.usernamePH}),n("<input>").attr({type:"password",name:"password",placeholder:l.passwordPH}),n("<input>").attr({type:"hidden",name:"action",value:"signin"}),n("<input>").attr({type:"hidden",name:"invitation",value:t.invitation}),n('<div class="submit">').append(n("<button>").text(l.signinSubmitText)),s([{href:p.resetPassword,text:l.resetPasswordLink},{href:p.signup,text:l.signupLink}])])}function r(){return a(p.signup,"signup").append([n("<h2>").text(l.signupTitle),n("<input>").attr({type:"text",name:"displayName",placeholder:l.displayNamePH}),n("<input>").attr({type:"email",name:"email",placeholder:l.emailPH}),n("<input>").attr({type:"text",name:"username",placeholder:l.usernamePH}),n("<input>").attr({type:"password",name:"password",placeholder:l.passwordPH}),n("<input>").attr({type:"password",name:"password_verify",placeholder:l.passwordVerifyPH}),n("<input>").attr({type:"hidden",name:"action",value:"signup"}),n("<input>").attr({type:"hidden",name:"invitation",value:t.invitation}),n('<div class="submit">').append(n("<button>").text(l.signupSubmitText)),s([{href:p.signin,text:l.signinLink}])])}function d(){return a(p.resetPassword,"signup").append([n("<h2>").text(l.resetPasswordTitle),n("<input>").attr({type:"email",name:"email",placeholder:l.emailPH}),n("<input>").attr({type:"hidden",name:"action",value:"reset-password"}),n('<div class="submit">').append(n("<button>").text(l.resetPasswordSubmitText)),s([{href:p.signin,text:l.signinLink}])])}var l=t.translations,p=e(t);return n('<div class="forms">').append([o(),d(),r()])}function i(e,t){var i=n('<a class="auth"></a>'),a="http://localhost:3000/auth/"+t.name;return e.invitation&&(a+="?invitation="+encodeURIComponent(e.invitation)),i.addClass(t.name),i.attr({href:a}),i.text(t.name),i}function a(e){var a=n("<div />").addClass("campsi-login").hide().append('<div class="fx">').append(n('<a class="close"></a>')).append('<div class="logo">').append(n("<h1>").html(e.translations.title)).append('<div class="user"></div>').append(n('<div class="buttons">'));return e.logo&&a.find(".logo").append(n("<img>").attr("src",e.logo)).css(e.logoStyle),n(e.providers).each(function(){"local"===this.name?a.append(t(e,this)):a.find(".buttons").append(i(e,this))}),a}function s(e,t,i){i=i||function(n){var e=new Error("campsi/login could not retreive auth providers");throw e.response=n,e},n.ajax({url:e.baseUrl+"/providers",dataType:"json",error:i}).done(t)}function o(n){return function(e){n.token&&e.setRequestHeader("Authorization","Bearer "+n.token.value)}}function r(e,t,i){n.ajax({url:e.baseUrl+"/me",beforeSend:o(e),success:t,error:i,dataType:"json"})}function d(n){var e=window.location.search,t=e.indexOf(n+"="),i=e.indexOf("&",t);if(t>-1)return t+=n.length+1,decodeURIComponent(e.substring(t,i===-1?e.length:i))}function l(n){var e,t,i=n.token||d("token"),a=typeof i;if("object"===a)return n.token;if(i&&"string"===a){try{e=JSON.parse(atob(i))}catch(n){console.dir(i),console.warn("invalid token"),console.warn(n)}return e}t=window.localStorage.getItem(n.localStorageKey);try{e=JSON.parse(t)}catch(n){console.warn("campsi/login could not parse stored token"),console.warn(n)}return e}function p(n,e){var t=n.data("campsi-login-settings");if(!t)return void console.error("campsi/login has not been instanciated. Please call $el.CampsiLogin({options}) first.");switch(e){case"show":g(n,t);break;case"hide":c(n);break;case"logout":u(n,t),g(n,t);break;case"displayUser":f(n,t);break;default:console.warn("campsi/login unknown command",e)}return n}function u(e,t){n.ajax({url:t.baseUrl+"/logout",dataType:"json",beforeSend:o(t)}).done(function(){window.localStorage.removeItem(t.localStorageKey),e.find(".user").empty(),e.removeClass("userLoggedIn"),e.find(".forms, .buttons").show(),w(e,t)})}function c(n){n.removeClass("visible").addClass("closed")}function g(n){n.addClass("visible").removeClass("closed")}function m(e){var t;if("object"==typeof e){if(e.translations&&(e.translations=n.extend({},n.fn.CampsiLogin.defaults.translations,e.translations)),t=n.extend({},n.fn.CampsiLogin.defaults,e),t.token=l(t),t.invitation=t.invitation||d("invitation"),!t.baseUrl)throw new Error("campsi/login missing baseUrl option");return t}}function f(e,t){var i=e.data("campsi-login-user"),a=t.translations;if(!i)return void console.error("campsi/login displayUser was called, but no user found");var s=n('<a href="#campsi-logout">').text(a.logoutText).on("click",function(){e.CampsiLogin("logout")});e.find(".user").empty(),e.find(".user").empty().append(n('<div class="displayName">').text(i.displayName)).append(n('<div class="pictureWrapper">').append(n("<img>").attr("src",i.picture))).append(s)}function h(e,t){e.on("click",".close",function(){e.CampsiLogin("hide")}),n(window).on("hashchange",function(){w(e,t)})}function w(n,t){var i=e(t),a=0===location.hash.indexOf("#"+t.translations.idPrefix)?location.hash:null,s=a||i[t.state]||i.signin;n.find("form").hide(),n.find(s).show()}n.fn.CampsiLogin=function(e){function t(){i.find(".campsi-login").show(),n(window).trigger("hashchange")}var i=this,o=m(e);return"string"==typeof e?p(i,e):i.hasClass("campsi-login-wrapper")?void console.info("campsi/login has already been inited"):(s(o,function(n){o.providers=n,i.append(a(o)).addClass("campsi-login-wrapper").data("campsi-login-settings",o),h(i,o),o.token?r(o,function(n){window.localStorage.setItem(o.localStorageKey,JSON.stringify(n.token)),i.data("campsi-login-user",n).CampsiLogin("displayUser").addClass("userLoggedIn").trigger("login",n).find(".forms, .buttons").hide(),t()},function(){i.trigger("loginError"),t()}):t()}),i)},n.fn.CampsiLogin.defaults={autoShow:!0,localStorageKey:"campsi-login-token",logoStyle:{},translations:{title:"Login",idPrefix:"campsi-login",signinId:"signin",signinSubmitText:"Sign in",signinLink:"I have an account!",signinTitle:"Sign in",signupId:"signup",signupSubmitText:"Sign up",signupLink:"Sign up",signupTitle:"Sign up",resetPasswordId:"reset-password",resetPasswordSubmitText:"Send me the link",resetPasswordLink:"Forgot your password?",resetPasswordTitle:"Reset password",displayNamePH:"Display name",emailPH:"Email address",usernamePH:"Username",passwordPH:"Password",passwordVerifyPH:"Verify your password",logoutText:"Log out"}}}(window.jQuery);